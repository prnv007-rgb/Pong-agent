<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Can you beat Pong Ai?</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Press Start 2P', cursive;
            background-color: #111;
            color: #fff;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
        }
        .container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }
        canvas {
            border: 4px solid #fff;
            border-radius: 8px;
            box-shadow: 0 0 20px #0ff, 0 0 30px #0ff, 0 0 40px #0ff;
            transition: background-color 0.3s;
        }
        .screen-shake {
            animation: shake 0.5s;
        }
        @keyframes shake {
            0%, 100% { transform: translate(0, 0); }
            10%, 30%, 50%, 70%, 90% { transform: translate(-5px, 0); }
            20%, 40%, 60%, 80% { transform: translate(5px, 0); }
        }
        .hidden {
            display: none;
        }
        #startMenu {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            align-items: center;
            width: 600px;
            padding: 2rem;
            justify-content: center;
        }
        #gameContainer {
            position: relative;
            text-align: center;
        }
        #exitButton {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #d9534f;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            line-height: 36px;
            cursor: pointer;
            z-index: 10;
        }
        #exitButton:hover {
            background: #c9302c;
        }
        .btn {
            background-color: #333;
            border: 2px solid #fff;
            color: white;
            padding: 10px 20px;
            text-align: center;
            font-size: 14px;
            cursor: pointer;
            border-radius: 8px;
            transition: background-color 0.3s, transform 0.1s;
            box-shadow: 0 0 10px #fff;
        }
        .btn:hover {
            background-color: #555;
        }
        .btn.selected {
            background-color: #0ff;
            border-color: #0ff;
            color: #000;
        }
        #mainStartButton {
            background-color: #0ff;
            border: 2px solid #0ff;
            color: #000;
            padding: 15px 32px;
            font-size: 16px;
            cursor: pointer;
            border-radius: 8px;
            box-shadow: 0 0 20px #0ff;
        }
        .color-swatch {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #333;
            transition: border-color 0.3s, transform 0.2s;
        }
        .color-swatch:hover {
            transform: scale(1.1);
        }
        .color-swatch.selected {
            border-color: #ffffff;
        }
    </style>
</head>
<body>
    <div class="container" id="mainContainer">

        <div id="startMenu">
            <h1 class="text-4xl mb-4" style="text-shadow: 0 0 10px #f0f, 0 0 20px #f0f;">RL PONG EVOLVED</h1>
            <div class="options-group">
                <h3>Difficulty</h3>
                <div class="btn-group">
                    <button class="btn" id="diffEasy">Easy</button>
                    <button class="btn selected" id="diffMedium">Medium</button>
                    <button class="btn" id="diffHard">Hard</button>
                </div>
            </div>
            <div class="options-group">
                <h3>Background Color</h3>
                <div class="btn-group">
                    <div class="color-swatch selected" style="background-color: #000;" data-color="#000"></div>
                    <div class="color-swatch" style="background-color: #1D2B53;" data-color="#1D2B53"></div>
                    <div class="color-swatch" style="background-color: #7E2553;" data-color="#7E2553"></div>
                    <div class="color-swatch" style="background-color: #008751;" data-color="#008751"></div>
                </div>
            </div>
            <button id="mainStartButton">Start Game</button>
        </div>


        <div id="gameContainer" class="hidden">
            <button id="exitButton">X</button>
            <div class="scores flex justify-around w-[600px] my-5 text-3xl">
                <div id="playerScore">0</div>
                <div id="aiScore">0</div>
            </div>
            <canvas id="gameCanvas" width="600" height="400"></canvas>
        </div>
    </div>

    <script>

        const mainContainer = document.getElementById('mainContainer');
        const startMenu = document.getElementById('startMenu');
        const gameContainer = document.getElementById('gameContainer');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const mainStartButton = document.getElementById('mainStartButton');
        const exitButton = document.getElementById('exitButton');
        

        let synth;

        if (typeof Tone !== 'undefined') {
            synth = new Tone.Synth().toDestination();
        }
        const hitSound = () => synth && synth.triggerAttackRelease("C4", "8n");
        const scoreSound = () => synth && synth.triggerAttackRelease("G5", "4n");
        const wallSound = () => synth && synth.triggerAttackRelease("A2", "16n");


        const paddleWidth = 10;
        let playerPaddleHeight = 80;
        let aiPaddleHeight = 80;
        const player = { x: 0, y: canvas.height / 2 - playerPaddleHeight / 2, width: paddleWidth, color: '#0ff', score: 0 };
        const ai = { x: canvas.width - paddleWidth, y: canvas.height / 2 - aiPaddleHeight / 2, width: paddleWidth, color: '#f0f', score: 0 };
        const ball = { x: canvas.width / 2, y: canvas.height / 2, radius: 8, speed: 5, velocityX: 5, velocityY: 5, color: '#fff' };
        

        const particles = [];
        const obstacle = { x: canvas.width/2 - 15, y: canvas.height/2 - 15, width: 30, height: 30, color: '#ff0', velocityY: 2 };
        let powerUp = null;
        const powerUpTypes = ['growPlayer', 'shrinkAI'];


        let selectedDifficulty = 'medium';
        let selectedColor = '#000';
        const difficultySettings = {
            easy:   { aiSpeed: 3, epsilon: 0.9, epsilonDecay: 0.9995 },
            medium: { aiSpeed: 4.5, epsilon: 0.8, epsilonDecay: 0.999 },
            hard:   { aiSpeed: 6, epsilon: 0.6, epsilonDecay: 0.9985 }
        };
        const qTable = {};
        const learningRate = 0.5;
        const discountFactor = 0.9;
        let epsilon = difficultySettings[selectedDifficulty].epsilon;
        let lastState = null;
        let lastAction = null;
        let gameRunning = false;


        const diffButtons = document.querySelectorAll('#diffEasy, #diffMedium, #diffHard');
        diffButtons.forEach(button => {
            button.addEventListener('click', () => {
                diffButtons.forEach(btn => btn.classList.remove('selected'));
                button.classList.add('selected');
                selectedDifficulty = button.id.replace('diff', '').toLowerCase();
            });
        });

        const colorSwatches = document.querySelectorAll('.color-swatch');
        colorSwatches.forEach(swatch => {
            swatch.addEventListener('click', () => {
                colorSwatches.forEach(s => s.classList.remove('selected'));
                swatch.classList.add('selected');
                selectedColor = swatch.dataset.color;
            });
        });
        
        mainStartButton.addEventListener('click', async () => {
            
            if (typeof Tone !== 'undefined' && Tone.context.state !== 'running') {
                await Tone.start();
            }
            startMenu.classList.add('hidden');
            gameContainer.classList.remove('hidden');
            startGame();
        });

        exitButton.addEventListener('click', () => {
            gameRunning = false;
            gameContainer.classList.add('hidden');
            startMenu.classList.remove('hidden');
        });

        function startGame() {
            gameRunning = true;
            player.score = 0;
            ai.score = 0;
            epsilon = difficultySettings[selectedDifficulty].epsilon;
            resetBall();
        }

 
        function drawRect(x, y, w, h, color, glow = false) {
            if (glow) {
                ctx.shadowColor = color;
                ctx.shadowBlur = 20;
            }
            ctx.fillStyle = color;
            ctx.fillRect(x, y, w, h);
            ctx.shadowBlur = 0; 
        }

        function drawCircle(x, y, r, color, glow = false) {
            if (glow) {
                ctx.shadowColor = color;
                ctx.shadowBlur = 20;
            }
            ctx.fillStyle = color;
            ctx.beginPath();
            ctx.arc(x, y, r, Math.PI * 2, false);
            ctx.closePath();
            ctx.fill();
            ctx.shadowBlur = 0; // Reset shadow
        }

        function drawNet() {
            for (let i = 0; i <= canvas.height; i += 15) {
                drawRect(canvas.width / 2 - 1, i, 2, 10, 'rgba(255, 255, 255, 0.5)');
            }
        }
        
        function render() {
            
            ctx.fillStyle = selectedColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            if(gameRunning) {
                drawNet();
                document.getElementById('playerScore').textContent = player.score;
                document.getElementById('aiScore').textContent = ai.score;
                
                drawRect(player.x, player.y, player.width, playerPaddleHeight, player.color, true);
                drawRect(ai.x, ai.y, ai.width, aiPaddleHeight, ai.color, true);
                
                drawRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height, obstacle.color, true);

                for(let i = particles.length - 1; i >= 0; i--) {
                    const p = particles[i];
                    drawCircle(p.x, p.y, p.radius, p.color);
                    p.radius -= 0.1;
                    if(p.radius <= 0) particles.splice(i, 1);
                }
                
                drawCircle(ball.x, ball.y, ball.radius, ball.color, true);
                
                if (powerUp) {
                    ctx.fillStyle = powerUp.color;
                    ctx.font = "24px 'Press Start 2P'";
                    ctx.fillText(powerUp.symbol, powerUp.x, powerUp.y);
                }
            }
        }

        // --- Game Logic ---
        function resetBall() {
            ball.x = canvas.width / 2;
            ball.y = canvas.height / 2;
            ball.speed = 5;
            ball.velocityX = -ball.velocityX;
            ball.velocityY = 5 * (Math.random() > 0.5 ? 1 : -1);
            if (lastState && lastAction !== null) {
                updateQValue(-100);
            }
            lastState = null;
            lastAction = null;
            
            if (Math.random() < 0.2) spawnPowerUp();
        }
        
        function collision(b, p, isPaddle = false) {
            const pHeight = isPaddle ? (p === player ? playerPaddleHeight : aiPaddleHeight) : p.height;
            b.top = b.y - b.radius; b.bottom = b.y + b.radius;
            b.left = b.x - b.radius; b.right = b.x + b.radius;
            p.top = p.y; p.bottom = p.y + pHeight;
            p.left = p.x; p.right = p.x + p.width;
            return b.right > p.left && b.bottom > p.top && b.left < p.right && b.top < p.bottom;
        }

        function update() {
            if (!gameRunning) return;

            ball.x += ball.velocityX;
            ball.y += ball.velocityY;
            particles.push({ x: ball.x, y: ball.y, radius: ball.radius / 2, color: 'rgba(255, 255, 255, 0.5)'});

            obstacle.y += obstacle.velocityY;
            if (obstacle.y <= 0 || obstacle.y + obstacle.height >= canvas.height) {
                obstacle.velocityY *= -1;
            }
            
            if (ball.y + ball.radius > canvas.height || ball.y - ball.radius < 0) {
                ball.velocityY = -ball.velocityY;
                wallSound();
            }
            
            if(collision(ball, obstacle)) {
                ball.velocityX *= -1;
                hitSound();
            }

            let activePaddle = (ball.x < canvas.width / 2) ? player : ai;
            if (collision(ball, activePaddle, true)) {
                let paddleHeight = activePaddle === player ? playerPaddleHeight : aiPaddleHeight;
                let collidePoint = (ball.y - (activePaddle.y + paddleHeight / 2)) / (paddleHeight / 2);
                let angleRad = (Math.PI / 4) * collidePoint;
                let direction = (ball.x < canvas.width / 2) ? 1 : -1;
                ball.velocityX = direction * ball.speed * Math.cos(angleRad);
                ball.velocityY = ball.speed * Math.sin(angleRad);
                ball.speed += 0.2;
                hitSound();
                
                if(activePaddle === ai && lastState && lastAction !== null) {
                    updateQValue(10);
                }
            }

            if (ball.x - ball.radius < 0) {
                ai.score++;
                scoreSound();
                mainContainer.classList.add('screen-shake');
                setTimeout(() => mainContainer.classList.remove('screen-shake'), 500);
                resetBall();
            } else if (ball.x + ball.radius > canvas.width) {
                player.score++;
                scoreSound();
                mainContainer.classList.add('screen-shake');
                setTimeout(() => mainContainer.classList.remove('screen-shake'), 500);
                resetBall();
            }
            
            if (powerUp && collision(ball, powerUp)) {
                activatePowerUp(powerUp.type);
                powerUp = null;
            }

            handleAI();
        }
        
        // --- Power-up Logic ---
        function spawnPowerUp() {
            const type = powerUpTypes[Math.floor(Math.random() * powerUpTypes.length)];
            powerUp = {
                x: canvas.width / 2 - 10,
                y: Math.random() * (canvas.height - 40) + 20,
                width: 20, height: 20,
                type: type,
                color: type === 'growPlayer' ? '#0f0' : '#f00',
                symbol: type === 'growPlayer' ? 'P+' : 'A-'
            };
        }
        
        function activatePowerUp(type) {
            if (type === 'growPlayer') {
                playerPaddleHeight = 120;
                setTimeout(() => playerPaddleHeight = 80, 5000);
            } else if (type === 'shrinkAI') {
                aiPaddleHeight = 40;
                setTimeout(() => aiPaddleHeight = 80, 5000);
            }
        }

        // --- RL Functions ---
        function getState() {
            const stateY = Math.floor(ball.y / 20);
            const stateX = Math.floor(ball.x / 20);
            const stateVY = ball.velocityY > 0 ? 1 : -1;
            const obstacleStateY = Math.floor(obstacle.y / 40);
            if (ball.velocityX > 0) {
                 return `${stateX}-${stateY}-${stateVY}-${obstacleStateY}`;
            }
            return null;
        }

        function chooseAction(state) {
            if (!qTable[state]) {
                qTable[state] = { 0: 0, 1: 0 }; 
            }
            if (Math.random() < epsilon) {
                return Math.random() < 0.5 ? 0 : 1;
            } else {
                return qTable[state][0] >= qTable[state][1] ? 0 : 1;
            }
        }

        function updateQValue(reward) {
            const newState = getState();
            let maxNextQ = 0;
            if (newState && qTable[newState]) {
                maxNextQ = Math.max(qTable[newState][0], qTable[newState][1]);
            }
            const currentQ = qTable[lastState][lastAction];
            const newQ = currentQ + learningRate * (reward + discountFactor * maxNextQ - currentQ);
            qTable[lastState][lastAction] = newQ;
            epsilon *= difficultySettings[selectedDifficulty].epsilonDecay;
        }

        function handleAI() {
            const state = getState();
            if (state) {
                const action = chooseAction(state);
                const aiSpeed = difficultySettings[selectedDifficulty].aiSpeed;
                if (action === 0 && ai.y > 0) {
                    ai.y -= aiSpeed;
                } else if (action === 1 && ai.y < canvas.height - aiPaddleHeight) {
                    ai.y += aiSpeed;
                }
                lastState = state;
                lastAction = action;
            } else {
                if (ai.y + aiPaddleHeight / 2 < canvas.height / 2 - 10) {
                    ai.y += 2;
                } else if (ai.y + aiPaddleHeight / 2 > canvas.height / 2 + 10) {
                    ai.y -= 2;
                }
            }
        }

        function gameLoop() {
            update();
            render();
            requestAnimationFrame(gameLoop);
        }
        

        canvas.addEventListener('mousemove', (evt) => {
            let rect = canvas.getBoundingClientRect();
            player.y = evt.clientY - rect.top - playerPaddleHeight / 2;
            if (player.y < 0) player.y = 0;
            if (player.y > canvas.height - playerPaddleHeight) player.y = canvas.height - playerPaddleHeight;
        });
        
        // Initial render
        requestAnimationFrame(gameLoop);
    </script>
</body>
</html>
